<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valores Previstos de Espirometria: Crianças de 3 a 12 anos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
            font-size: 0.95em;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group select {
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            width: calc(100% - 30px); /* Adjust for padding */
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #fcfcfc;
        }

        .input-group select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }
        .observed-values-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }

        .observed-values-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .observed-values-column {
            flex: 1;
            min-width: 280px;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        #results {
            margin-top: 30px;
            padding: 25px;
            background-color: #e8f4f8;
            border-radius: 10px;
            border: 1px solid #c2e1f0;
            color: #2c3e50;
        }

        #results h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6em;
            text-align: center;
        }

        .result-warning {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none; /* Hidden by default */
        }

        .exam-details {
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
            font-size: 0.95em;
        }
        .exam-details p {
            margin: 8px 0;
        }
        .exam-details strong {
            color: #2c3e50;
        }

        .citation {
            font-style: italic;
            font-size: 0.85em;
            text-align: right;
            margin-top: -15px;
            margin-bottom: 20px;
            color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        table th, table td {
            border: 1px solid #c2e1f0;
            padding: 10px;
            text-align: center;
        }

        table th {
            background-color: #d1e7f0;
            color: #2c3e50;
            font-weight: bold;
        }

        table tr:nth-child(even) {
            background-color: #f0f8fb;
        }

        table td:first-child {
            text-align: left;
            font-weight: bold;
            color: #333;
        }

        .value-below-lin {
            color: #c0392b; /* Vermelho escuro */
            font-weight: bold;
        }
        .change-significant-green {
            color: #27ae60; /* Verde escuro */
            font-weight: bold;
        }

        #interpretation-section, #interpretation-section-post {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        #interpretation-section h2, #interpretation-section-post h2 {
            margin-bottom: 15px;
        }
        #interpretation-text-pre, #interpretation-text-post {
            line-height: 1.6;
            text-align: justify;
        }

        .action-buttons-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .action-buttons-group button {
            width: auto;
            flex-grow: 1;
            max-width: 250px;
        }

        .chart-container {
            display: none !important;
        }

        @media print {
            body {
                margin: 0 !important;
                padding: 0 !important;
                font-size: 10pt; 
            }
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 10px !important; 
                width: 100% !important;
                max-width: 100% !important;
            }
            h1 {
                font-size: 1.4em !important;
                margin-top: 10px !important;
                margin-bottom: 15px !important;
            }
            h2 {
                font-size: 1.1em !important;
                margin-top: 5px !important;
                margin-bottom: 10px !important;
            }
            .exam-details {
                font-size: 0.85em !important;
                margin-bottom: 5px !important;
                padding-bottom: 5px !important;
                border-bottom: 0.5px dashed #ccc !important;
            }
             .exam-details p {
                margin: 4px 0;
            }
            .citation {
                font-size: 0.7em !important;
                margin-top: 5px !important;
                margin-bottom: 5px !important;
            }
            table {
                font-size: 0.75em !important; 
                margin-top: 5px !important;
                margin-bottom: 10px !important;
            }
            table th, table td {
                padding: 4px !important; 
            }
            .spirometry-form, .action-buttons-group, .result-warning, .error-message {
                display: none !important;
            }
            #results {
                padding: 0 !important;
                background-color: transparent !important;
                border: none !important;
                box-shadow: none !important;
                margin-top: 10px !important;
            }
            #interpretation-section, #interpretation-section-post {
                display: block !important;
                font-size: 0.85em !important; 
                margin-top: 10px !important;
                padding-top: 10px !important;
                border-top: 0.5px dashed #ccc !important;
            }
             #interpretation-text-pre, #interpretation-text-post {
                line-height: 1.4; 
            }
        }
    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    </head>
<body>
    <div class="container">
        <h1>Valores Previstos de Espirometria: Crianças de 3 a 12 anos</h1>
        <form id="spirometryForm" class="spirometry-form">
            <div class="input-group">
                <label for="patientName">Nome do Paciente:</label>
                <input type="text" id="patientName" required>
                <div class="error-message" id="patientNameError">Nome do paciente é obrigatório.</div>
            </div>

            <div class="input-group">
                <label for="examDate">Data do Exame:</label>
                <input type="date" id="examDate" required>
                <div class="error-message" id="examDateError">Data do exame é obrigatória.</div>
            </div>

            <div class="input-group">
                <label for="doctorName">Nome do Médico:</label>
                <input type="text" id="doctorName" required>
                <div class="error-message" id="doctorNameError">Nome do médico é obrigatório.</div>
            </div>

            <div class="input-group">
                <label for="clinicName">Clínica:</label>
                <input type="text" id="clinicName" required>
                <div class="error-message" id="clinicNameError">Nome da clínica é obrigatório.</div>
            </div>

            <div class="input-group">
                <label for="ageYears">Idade (anos):</label>
                <input type="number" id="ageYears" min="3" max="12" step="1" required>
                <div class="error-message" id="ageError">A idade deve estar entre 3 e 12 anos.</div>
            </div>

            <div class="input-group">
                <label for="ageMonths">Idade (meses, opcional):</label>
                <input type="number" id="ageMonths" min="0" max="11" step="1" value="0">
                <div class="error-message" id="ageMonthsError">Os meses devem estar entre 0 e 11.</div>
            </div>

            <div class="input-group">
                <label for="heightCm">Altura (cm):</label>
                <input type="number" id="heightCm" min="50" max="200" step="0.1" required>
                <div class="error-message" id="heightError">A altura deve ser um valor válido em cm.</div>
            </div>

            <div class="input-group">
                <label for="gender">Sexo:</label>
                <select id="gender" required>
                    <option value="">Selecione</option>
                    <option value="male">Masculino</option>
                    <option value="female">Feminino</option>
                </select>
                <div class="error-message" id="genderError">Selecione o sexo.</div>
            </div>

            <div class="input-group">
                <label for="colorCode">Cor:</label>
                <select id="colorCode" required>
                    <option value="">Selecione</option>
                    <option value="0">Branco</option>
                    <option value="1">Negro ou Pardo</option>
                </select>
                <div class="error-message" id="colorCodeError">Selecione a cor.</div>
            </div>

            <div class="observed-values-section">
                <h2>Valores Observados</h2>
                <div class="observed-values-group">
                    <div class="observed-values-column">
                        <h3>Pré-Broncodilatador</h3>
                        <div class="input-group">
                            <label for="obsCVF_pre">CVF (L):</label>
                            <input type="number" id="obsCVF_pre" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsVEF1_pre">VEF1 (L):</label>
                            <input type="number" id="obsVEF1_pre" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsFEF2575_pre">FEF25-75% (L/s):</label>
                            <input type="number" id="obsFEF2575_pre" step="0.01">
                        </div>
                    </div>

                    <div class="observed-values-column">
                        <h3>Pós-Broncodilatador</h3>
                        <div class="input-group">
                            <label for="obsCVF_post">CVF (L):</label>
                            <input type="number" id="obsCVF_post" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsVEF1_post">VEF1 (L):</label>
                            <input type="number" id="obsVEF1_post" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsFEF2575_post">FEF25-75% (L/s):</label>
                            <input type="number" id="obsFEF2575_post" step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit">Calcular Espirometria</button>
        </form>

        <div id="results" style="display: none;">
            <div class="result-warning" id="ageRangeWarning" style="display: none;">
                Atenção: A idade da criança está fora da faixa recomendada (3 a 12 anos, 11 meses e 29 dias). Os resultados podem não ser precisos.
            </div>

            <div class="exam-details">
                <p><strong>Paciente:</strong> <span id="displayPatientName"></span> - <strong>Idade:</strong> <span id="displayPatientAge"></span> - <strong>Altura:</strong> <span id="displayPatientHeight"></span></p>
                <p><strong>Data do Exame:</strong> <span id="displayExamDate"></span></p>
                <p><strong>Médico Responsável:</strong> <span id="displayDoctorName"></span></p>
                <p><strong>Clínica:</strong> <span id="displayClinicName"></span></p>
            </div>

            <h2>Resultados Pré-Broncodilatador</h2>
            <table>
                <thead>
                    <tr>
                        <th>Variável</th>
                        <th>Observado</th>
                        <th>Previsto</th>
                        <th>LIN</th>
                        <th>% do Previsto</th>
                        <th>Z-score</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBodyPre">
                </tbody>
            </table>

            <h2>Resultados Pós-Broncodilatador e Reversibilidade</h2>
            <table>
                <thead>
                    <tr>
                        <th>Variável</th>
                        <th>Observado Pós-BD</th>
                        <th>% do Previsto Pós-BD</th>
                        <th>Z-score Pós-BD</th>
                        <th>Dif. Abs.</th>
                        <th>Dif. % do Previsto</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBodyPostAndReversibility">
                </tbody>
            </table>
            <p class="citation">Valores previstos: Jones et al. Jornal Brasileiro de Pneumologia, 2020</p>

            <div id="interpretation-section">
                <h2>Interpretação do Exame (Pré-Broncodilatador)</h2>
                <p id="interpretation-text-pre"></p>
            </div>

            <div id="interpretation-section-post" style="display: none;">
                <h2>Interpretação do Exame (Pós-Broncodilatador)</h2>
                <p id="interpretation-text-post"></p>
            </div>

            <div class="action-buttons-group">
                <button type="button" id="printButton">Imprimir (PDF)</button>
                <button type="button" id="shareButton">Compartilhar (PNG)</button>
                <button type="button" id="resetButton">Novo Exame</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const savedDoctorName = localStorage.getItem('doctorName');
            if (savedDoctorName) {
                document.getElementById('doctorName').value = savedDoctorName;
            }
            const savedClinicName = localStorage.getItem('clinicName');
            if (savedClinicName) {
                document.getElementById('clinicName').value = savedClinicName;
            }
            const today = new Date();
            const foundry = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('examDate').value = `${foundry}-${mm}-${dd}`;
        });

        document.getElementById('doctorName').addEventListener('input', (event) => {
            localStorage.setItem('doctorName', event.target.value);
        });
        document.getElementById('clinicName').addEventListener('input', (event) => {
            localStorage.setItem('clinicName', event.target.value);
        });


        document.getElementById('spirometryForm').addEventListener('submit', function(event) {
            event.preventDefault(); 

            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('ageRangeWarning').style.display = 'none';

            let isValid = true;

            const patientName = document.getElementById('patientName').value.trim();
            const examDate = document.getElementById('examDate').value; 
            const doctorName = document.getElementById('doctorName').value.trim();
            const clinicName = document.getElementById('clinicName').value.trim(); 
            const ageYears = parseFloat(document.getElementById('ageYears').value);
            const ageMonths = parseFloat(document.getElementById('ageMonths').value);
            const heightCm = parseFloat(document.getElementById('heightCm').value);
            const gender = document.getElementById('gender').value;
            const colorCode = parseFloat(document.getElementById('colorCode').value);

            const obsCVF_pre = parseFloat(document.getElementById('obsCVF_pre').value) || null;
            const obsVEF1_pre = parseFloat(document.getElementById('obsVEF1_pre').value) || null;
            const obsFEF2575_pre = parseFloat(document.getElementById('obsFEF2575_pre').value) || null;

            const obsCVF_post = parseFloat(document.getElementById('obsCVF_post').value) || null;
            const obsVEF1_post = parseFloat(document.getElementById('obsVEF1_post').value) || null;
            const obsFEF2575_post = parseFloat(document.getElementById('obsFEF2575_post').value) || null;

            if (!patientName) {
                document.getElementById('patientNameError').style.display = 'block';
                isValid = false;
            }
            if (!examDate) {
                document.getElementById('examDateError').style.display = 'block';
                isValid = false;
            }
            if (!doctorName) {
                document.getElementById('doctorNameError').style.display = 'block';
                isValid = false;
            }
            if (!clinicName) { 
                document.getElementById('clinicNameError').style.display = 'block';
                isValid = false;
            }
            if (isNaN(ageYears) || ageYears < 3 || ageYears > 12) {
                document.getElementById('ageError').style.display = 'block';
                isValid = false;
            }
            if (isNaN(ageMonths) || ageMonths < 0 || ageMonths > 11) {
                document.getElementById('ageMonthsError').style.display = 'block';
                isValid = false;
            }
            if (isNaN(heightCm) || heightCm <= 0) {
                document.getElementById('heightError').style.display = 'block';
                isValid = false;
            }
            if (gender === "") {
                document.getElementById('genderError').style.display = 'block';
                isValid = false;
            }
            if (isNaN(colorCode)) {
                document.getElementById('colorCodeError').style.display = 'block';
                isValid = false;
            }

            if (!isValid) {
                document.getElementById('results').style.display = 'none';
                return;
            }
            
            const formatValue = (value, decimals = 2) => value === null || isNaN(value) ? 'N/A' : value.toFixed(decimals);

            document.getElementById('displayPatientName').textContent = patientName;
            const ageDisplay = `${ageYears} anos` + (ageMonths > 0 ? ` e ${ageMonths} meses` : '');
            document.getElementById('displayPatientAge').textContent = ageDisplay;
            document.getElementById('displayPatientHeight').textContent = formatValue(heightCm, 1) + ' cm';
            // Adicionar T00:00:00 para garantir que a data seja interpretada como local e evitar problemas de fuso horário na formatação
            document.getElementById('displayExamDate').textContent = new Date(examDate + 'T00:00:00').toLocaleDateString('pt-BR');
            document.getElementById('displayDoctorName').textContent = doctorName;
            document.getElementById('displayClinicName').textContent = clinicName; 

            const totalAgeInYears = ageYears + (ageMonths / 12);
            const lnAge = Math.log(totalAgeInYears);
            const lnHeight = Math.log(heightCm);

            if (totalAgeInYears < 3 || totalAgeInYears >= 13) {
                document.getElementById('ageRangeWarning').style.display = 'block';
            }

            let prevCVF, prevVEF1, prevVEF1CVF, prevFEF2575, prevFEF2575CVF;
            let linCVF, linVEF1, linVEF1CVF, linFEF2575, linFEF2575CVF;

            const coefMalePrev = {
                intercept: { cvf: -11.358191, vef1: -10.434226, vef1cvf: 1.760961, fef2575: -6.957857, fef2575cvf: 6.185501 },
                lnAltura: { cvf: 2.419817, vef1: 2.207609, vef1cvf: -0.176748, fef2575: 1.527303, fef2575cvf: -1.044205 },
                lnIdade: { cvf: 0.115477, vef1: 0.114001, vef1cvf: 0, fef2575: 0.138649, fef2575cvf: 0 },
                cor: { cvf: -0.028745, vef1: -0.031836, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.093297 }
            };
            const coefFemalePrev = {
                intercept: { cvf: -10.741935, vef1: -9.967774, vef1cvf: 1.437685, fef2575: -7.385469, fef2575cvf: 5.041747 },
                lnAltura: { cvf: 2.261976, vef1: 2.08895, vef1cvf: -0.106215, fef2575: 1.594033, fef2575cvf: -0.785773 },
                lnIdade: { cvf: 0.156836, vef1: 0.150386, vef1cvf: 0, fef2575: 0.203576, fef2575cvf: 0 },
                cor: { cvf: -0.041015, vef1: -0.048582, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.046472 }
            };
            const coefMaleLIN = {
                intercept: { cvf: -9.32749, vef1: -8.960184, vef1cvf: 1.94278, fef2575: -5.356269, fef2575cvf: 4.579022 },
                lnAltura: { cvf: 1.890179, vef1: 1.820202, vef1cvf: -0.231255, fef2575: 1.085145, fef2575cvf: -0.78661 },
                lnIdade: { cvf: 0.268924, vef1: 0.208981, vef1cvf: 0, fef2575: 0.211021, fef2575cvf: 0 },
                cor: { cvf: -0.042377, vef1: -0.026383, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.036968 }
            };
            const coefFemaleLIN = {
                intercept: { cvf: -10.325884, vef1: -8.934018, vef1cvf: 1.313149, fef2575: -7.85519, fef2575cvf: 3.919387 },
                lnAltura: { cvf: 2.098703, vef1: 1.768038, vef1cvf: -0.100805, fef2575: 1.673427, fef2575cvf: -0.642607 },
                lnIdade: { cvf: 0.23022, vef1: 0.290733, vef1cvf: 0, fef2575: 0.056126, fef2575cvf: 0 },
                cor: { cvf: -0.073692, vef1: -0.054695, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.027623 }
            };
            const seeMale = { cvf: 0.1362, vef1: 0.1284, vef1cvf: 0.04988, fef2575: 0.224, fef2575cvf: 0.2694 };
            const seeFemale = { cvf: 0.1443, vef1: 0.1369, vef1cvf: 0.05075, fef2575: 0.2297, fef2575cvf: 0.2929 };

            let currentCoefsPrev, currentCoefsLIN, currentSEE;

            if (gender === 'male') {
                currentCoefsPrev = coefMalePrev; currentCoefsLIN = coefMaleLIN; currentSEE = seeMale;
            } else {
                currentCoefsPrev = coefFemalePrev; currentCoefsLIN = coefFemaleLIN; currentSEE = seeFemale;
            }

            const calculatePredictedValues = (coefsPrev, lnHeight, lnAge, colorCode) => {
                const lnPrevCVF = coefsPrev.intercept.cvf + (lnHeight * coefsPrev.lnAltura.cvf) + (lnAge * coefsPrev.lnIdade.cvf) + (colorCode * coefsPrev.cor.cvf);
                const prevCVF = Math.exp(lnPrevCVF);
                const lnPrevVEF1 = coefsPrev.intercept.vef1 + (lnHeight * coefsPrev.lnAltura.vef1) + (lnAge * coefsPrev.lnIdade.vef1) + (colorCode * coefsPrev.cor.vef1);
                const prevVEF1 = Math.exp(lnPrevVEF1);
                const prevVEF1CVF = coefsPrev.intercept.vef1cvf + (lnHeight * coefsPrev.lnAltura.vef1cvf) + (lnAge * coefsPrev.lnIdade.vef1cvf) + (colorCode * coefsPrev.cor.vef1cvf);
                const lnPrevFEF2575 = coefsPrev.intercept.fef2575 + (lnHeight * coefsPrev.lnAltura.fef2575) + (lnAge * coefsPrev.lnIdade.fef2575) + (colorCode * coefsPrev.cor.fef2575);
                const prevFEF2575 = Math.exp(lnPrevFEF2575);
                const prevFEF2575CVF = coefsPrev.intercept.fef2575cvf + (lnHeight * coefsPrev.lnAltura.fef2575cvf) + (lnAge * coefsPrev.lnIdade.fef2575cvf) + (colorCode * coefsPrev.cor.fef2575cvf);
                return { prevCVF, prevVEF1, prevVEF1CVF, prevFEF2575, prevFEF2575CVF, lnPrevCVF, lnPrevVEF1, lnPrevFEF2575 };
            };
            const predictedValues = calculatePredictedValues(currentCoefsPrev, lnHeight, lnAge, colorCode);
            prevCVF = predictedValues.prevCVF; prevVEF1 = predictedValues.prevVEF1; prevVEF1CVF = predictedValues.prevVEF1CVF;
            prevFEF2575 = predictedValues.prevFEF2575; prevFEF2575CVF = predictedValues.prevFEF2575CVF;

            const calculateLINValues = (coefsLIN, lnHeight, lnAge, colorCode) => {
                const lnLINCVF = coefsLIN.intercept.cvf + (lnHeight * coefsLIN.lnAltura.cvf) + (lnAge * coefsLIN.lnIdade.cvf) + (colorCode * coefsLIN.cor.cvf);
                const linCVF = Math.exp(lnLINCVF);
                const lnLINVEF1 = coefsLIN.intercept.vef1 + (lnHeight * coefsLIN.lnAltura.vef1) + (lnAge * coefsLIN.lnIdade.vef1) + (colorCode * coefsLIN.cor.vef1);
                const linVEF1 = Math.exp(lnLINVEF1);
                const linVEF1CVF = coefsLIN.intercept.vef1cvf + (lnHeight * coefsLIN.lnAltura.vef1cvf) + (lnAge * coefsLIN.lnIdade.vef1cvf) + (colorCode * coefsLIN.cor.vef1cvf);
                const lnLINFEF2575 = coefsLIN.intercept.fef2575 + (lnHeight * coefsLIN.lnAltura.fef2575) + (lnAge * coefsLIN.lnIdade.fef2575) + (colorCode * coefsLIN.cor.fef2575);
                const linFEF2575 = Math.exp(lnLINFEF2575);
                const linFEF2575CVF = coefsLIN.intercept.fef2575cvf + (lnHeight * coefsLIN.lnAltura.fef2575cvf) + (lnAge * coefsLIN.lnIdade.fef2575cvf) + (colorCode * coefsLIN.cor.fef2575cvf);
                return { linCVF, linVEF1, linVEF1CVF, linFEF2575, linFEF2575CVF };
            };
            const linValues = calculateLINValues(currentCoefsLIN, lnHeight, lnAge, colorCode);
            linCVF = linValues.linCVF; linVEF1 = linValues.linVEF1; linVEF1CVF = linValues.linVEF1CVF;
            linFEF2575 = linValues.linFEF2575; linFEF2575CVF = linValues.linFEF2575CVF;

            const computeDerivedObserved = (obsVEF1, obsCVF, obsFEF2575) => {
                const computedObsVEF1CVF = (obsVEF1 !== null && obsCVF !== null && obsCVF !== 0) ? (obsVEF1 / obsCVF) : null;
                const computedObsFEF2575CVF = (obsFEF2575 !== null && obsCVF !== null && obsCVF !== 0) ? (obsFEF2575 / obsCVF) : null;
                return { computedObsVEF1CVF, computedObsFEF2575CVF };
            };
            const derivedObsPre = computeDerivedObserved(obsVEF1_pre, obsCVF_pre, obsFEF2575_pre);
            const computedObsVEF1CVF_pre = derivedObsPre.computedObsVEF1CVF;
            const computedObsFEF2575CVF_pre = derivedObsPre.computedObsFEF2575CVF;
            const derivedObsPost = computeDerivedObserved(obsVEF1_post, obsCVF_post, obsFEF2575_post);
            const computedObsVEF1CVF_post = derivedObsPost.computedObsVEF1CVF;
            const computedObsFEF2575CVF_post = derivedObsPost.computedObsFEF2575CVF;

            const calculateZScore = (obsVal, prevValRaw, seeVal, isLogTransformed) => {
                if (obsVal === null || isNaN(obsVal) || prevValRaw === null || isNaN(prevValRaw) || seeVal === 0 || isNaN(seeVal)) return null;
                let numerator;
                if (isLogTransformed) {
                    if (obsVal <= 0) return null; 
                    numerator = Math.log(obsVal) - Math.log(prevValRaw);
                } else {
                    numerator = obsVal - prevValRaw;
                }
                return numerator / seeVal;
            };
            let zScoreCVF_pre = calculateZScore(obsCVF_pre, prevCVF, currentSEE.cvf, true);
            let zScoreVEF1_pre = calculateZScore(obsVEF1_pre, prevVEF1, currentSEE.vef1, true);
            let zScoreVEF1CVF_pre = calculateZScore(computedObsVEF1CVF_pre, prevVEF1CVF, currentSEE.vef1cvf, false);
            let zScoreFEF2575_pre = calculateZScore(obsFEF2575_pre, prevFEF2575, currentSEE.fef2575, true);
            let zScoreFEF2575CVF_pre = calculateZScore(computedObsFEF2575CVF_pre, prevFEF2575CVF, currentSEE.fef2575cvf, false);

            let zScoreCVF_post = calculateZScore(obsCVF_post, prevCVF, currentSEE.cvf, true);
            let zScoreVEF1_post = calculateZScore(obsVEF1_post, prevVEF1, currentSEE.vef1, true);
            let zScoreVEF1CVF_post = calculateZScore(computedObsVEF1CVF_post, prevVEF1CVF, currentSEE.vef1cvf, false);
            let zScoreFEF2575_post = calculateZScore(obsFEF2575_post, prevFEF2575, currentSEE.fef2575, true);
            let zScoreFEF2575CVF_post = calculateZScore(computedObsFEF2575CVF_post, prevFEF2575CVF, currentSEE.fef2575cvf, false);
            
            const calculatePercentage = (observed, predicted) => {
                if (observed === null || isNaN(observed) || predicted === null || isNaN(predicted) || predicted === 0) return 'N/A';
                return ((observed / predicted) * 100).toFixed(2);
            };
            const calculateDiffPercentOfPredicted = (obsPre, obsPost, predicted) => {
                if (obsPre === null || obsPost === null || isNaN(obsPre) || isNaN(obsPost) || predicted === null || isNaN(predicted) || predicted === 0) return null;
                const absDiff = obsPost - obsPre;
                return (absDiff / predicted) * 100;
            };

            const addPreResultRow = (item, observedVal, predictedVal, linVal, zScoreVal) => {
                const tbody = document.getElementById('resultsTableBodyPre');
                const row = tbody.insertRow();
                row.insertCell().textContent = item.name; 
                const cellObs = row.insertCell(); cellObs.textContent = formatValue(observedVal); 
                row.insertCell().textContent = formatValue(predictedVal); 
                row.insertCell().textContent = formatValue(linVal); 
                const percentPrev = calculatePercentage(observedVal, predictedVal);
                const cellPercent = row.insertCell(); cellPercent.textContent = percentPrev + '%'; 
                const cellZscore = row.insertCell(); cellZscore.textContent = formatValue(zScoreVal, 3); 
                if (observedVal !== null && linVal !== null && observedVal < linVal) {
                    cellObs.classList.add('value-below-lin'); cellPercent.classList.add('value-below-lin'); cellZscore.classList.add('value-below-lin');
                }
            };
            const addPostReversibilityResultRow = (item, observedPostVal, predictedVal, linVal, zScorePostVal, obsPreVal, reversibilityOpts = { unit: '', colorable: false }) => {
                const tbody = document.getElementById('resultsTableBodyPostAndReversibility');
                const row = tbody.insertRow();
                row.insertCell().textContent = item.name;
                const cellObsPost = row.insertCell(); cellObsPost.textContent = formatValue(observedPostVal);
                const percentPrevPost = calculatePercentage(observedPostVal, predictedVal);
                const cellPercentPost = row.insertCell(); cellPercentPost.textContent = percentPrevPost + '%';
                const cellZscorePost = row.insertCell(); cellZscorePost.textContent = formatValue(zScorePostVal, 3);
                if (observedPostVal !== null && linVal !== null && observedPostVal < linVal) {
                    cellObsPost.classList.add('value-below-lin'); cellPercentPost.classList.add('value-below-lin'); cellZscorePost.classList.add('value-below-lin');
                }
                const cellAbsDiff = row.insertCell(); const cellDiffPercentOfPredicted = row.insertCell();
                const absDiff = (observedPostVal !== null && obsPreVal !== null) ? (observedPostVal - obsPreVal) : null;
                const diffPercentOfPredictedValue = calculateDiffPercentOfPredicted(obsPreVal, observedPostVal, predictedVal);
                let formattedAbsDiff = 'N/A';
                if (absDiff !== null) {
                    if (reversibilityOpts.unit === 'L') formattedAbsDiff = formatValue(absDiff * 1000, 0) + ' mL';
                    else if (reversibilityOpts.unit === 'L/s') formattedAbsDiff = formatValue(absDiff) + ' L/s';
                    else if (reversibilityOpts.unit === 'ratio') formattedAbsDiff = formatValue(absDiff, 3);
                    else formattedAbsDiff = formatValue(absDiff);
                }
                cellAbsDiff.textContent = formattedAbsDiff;
                cellDiffPercentOfPredicted.textContent = formatValue(diffPercentOfPredictedValue) + '%';
                if (reversibilityOpts.colorable && diffPercentOfPredictedValue !== null && diffPercentOfPredictedValue >= 10) {
                    cellDiffPercentOfPredicted.classList.add('change-significant-green');
                }
            };

            document.getElementById('resultsTableBodyPre').innerHTML = ''; 
            addPreResultRow({ name: 'CVF (L)' }, obsCVF_pre, prevCVF, linCVF, zScoreCVF_pre);
            addPreResultRow({ name: 'VEF1 (L)' }, obsVEF1_pre, prevVEF1, linVEF1, zScoreVEF1_pre);
            addPreResultRow({ name: 'VEF1/CVF' }, computedObsVEF1CVF_pre, prevVEF1CVF, linVEF1CVF, zScoreVEF1CVF_pre);
            addPreResultRow({ name: 'FEF25-75% (L/s)' }, obsFEF2575_pre, prevFEF2575, linFEF2575, zScoreFEF2575_pre);
            addPreResultRow({ name: 'FEF25-75%/CVF' }, computedObsFEF2575CVF_pre, prevFEF2575CVF, linFEF2575CVF, zScoreFEF2575CVF_pre);

            document.getElementById('resultsTableBodyPostAndReversibility').innerHTML = ''; 
            addPostReversibilityResultRow({ name: 'CVF (L)' }, obsCVF_post, prevCVF, linCVF, zScoreCVF_post, obsCVF_pre, { unit: 'L', colorable: true });
            addPostReversibilityResultRow({ name: 'VEF1 (L)' }, obsVEF1_post, prevVEF1, linVEF1, zScoreVEF1_post, obsVEF1_pre, { unit: 'L', colorable: true });
            addPostReversibilityResultRow({ name: 'VEF1/CVF' }, computedObsVEF1CVF_post, prevVEF1CVF, linVEF1CVF, zScoreVEF1CVF_post, computedObsVEF1CVF_pre, { unit: 'ratio', colorable: false });
            addPostReversibilityResultRow({ name: 'FEF25-75% (L/s)' }, obsFEF2575_post, prevFEF2575, linFEF2575, zScoreFEF2575_post, obsFEF2575_pre, { unit: 'L/s', colorable: false });
            addPostReversibilityResultRow({ name: 'FEF25-75%/CVF' }, computedObsFEF2575CVF_post, prevFEF2575CVF, linFEF2575CVF, zScoreFEF2575CVF_post, computedObsFEF2575CVF_pre, { unit: 'ratio', colorable: false });

            const generateSingleInterpretation = (
                obsCVF, linCVF, obsVEF1, linVEF1, computedObsVEF1CVF, linVEF1CVF, zScoreCVF, label,
                classPreBD = null, 
                obsCVF_pre_param = null, obsVEF1_pre_param = null,
                prevCVF_param = null, prevVEF1_param = null 
            ) => {
                let baseInterpretationText = "";
                let calculatedClassification = "Sem Classificação"; 

                const isCVFValid = obsCVF !== null && !isNaN(obsCVF);
                const isVEF1Valid = obsVEF1 !== null && !isNaN(obsVEF1);
                const isVEF1CVFValid = computedObsVEF1CVF !== null && !isNaN(computedObsVEF1CVF);
                const isZScoreCVFValid = zScoreCVF !== null && !isNaN(zScoreCVF);

                if (isCVFValid && isVEF1Valid && isVEF1CVFValid) {
                    if (obsCVF >= linCVF && obsVEF1 >= linVEF1 && computedObsVEF1CVF >= linVEF1CVF) {
                        calculatedClassification = "Normal";
                        baseInterpretationText = `Todos os parâmetros (CVF: ${formatValue(obsCVF)} L, VEF1: ${formatValue(obsVEF1)} L, VEF1/CVF: ${formatValue(computedObsVEF1CVF, 3)}) encontram-se dentro ou acima dos limites da normalidade. Função pulmonar normal.`;
                    }
                    else if (isZScoreCVFValid && zScoreCVF >= 1 && isVEF1Valid && obsVEF1 > linVEF1 && computedObsVEF1CVF < linVEF1CVF) {
                        calculatedClassification = "Considerar Disanapsis";
                        baseInterpretationText = `CVF com Z-score >= 1 (Z-score CVF: ${formatValue(zScoreCVF,2)}), VEF1 acima do LIN (${formatValue(obsVEF1)} L), mas a relação VEF1/CVF está reduzida (${formatValue(computedObsVEF1CVF, 3)}). Estes achados podem sugerir disanapsis (desproporção entre o tamanho das vias aéreas e o volume pulmonar). Recomenda-se correlação clínica.`;
                    }
                    else if (obsCVF >= linCVF && computedObsVEF1CVF < linVEF1CVF) {
                        calculatedClassification = "Obstrutivo";
                        baseInterpretationText = `CVF encontra-se dentro da normalidade (${formatValue(obsCVF)} L), mas o índice VEF1/CVF está abaixo do LIN (${formatValue(computedObsVEF1CVF, 3)}). Isto é compatível com um padrão obstrutivo.`;
                    }
                    else if (obsCVF < linCVF && isVEF1Valid && obsVEF1 < linVEF1 && computedObsVEF1CVF >= linVEF1CVF) {
                        calculatedClassification = "Restritivo";
                        baseInterpretationText = `A Capacidade Vital Forçada (CVF: ${formatValue(obsCVF)} L) e o Volume Expiratório Forçado no primeiro segundo (VEF1: ${formatValue(obsVEF1)} L) estão abaixo do LIN, mas o índice VEF1/CVF (${formatValue(computedObsVEF1CVF, 3)}) está dentro da normalidade. Isto sugere um padrão restritivo.`;
                    }
                    else if (obsCVF < linCVF && computedObsVEF1CVF < linVEF1CVF) {
                        calculatedClassification = "Misto";
                        baseInterpretationText = `Tanto o CVF (${formatValue(obsCVF)} L) quanto o índice VEF1/CVF (${formatValue(computedObsVEF1CVF, 3)}) estão abaixo do LIN. Isto indica um padrão misto (obstrutivo e restritivo).`;
                    } else {
                        baseInterpretationText = "A combinação dos resultados não se enquadra claramente nos padrões definidos acima. Avaliação clínica detalhada é recomendada.";
                    }
                } else {
                     baseInterpretationText = "Não foi possível classificar devido a dados insuficientes para os parâmetros chave (CVF, VEF1, VEF1/CVF).";
                     calculatedClassification = "Dados Insuficientes";
                }

                let postBdSpecificText = ""; 
                if (label === "Pós-Broncodilatador") {
                    let postBdCommentsArray = []; 

                    if (calculatedClassification === "Normal" && classPreBD !== null && classPreBD !== "Normal") {
                        postBdCommentsArray.push("Houve normalização da função pulmonar global após o uso do broncodilatador.");
                    }

                    if (obsCVF_pre_param !== null && linCVF !== null && obsCVF_pre_param < linCVF &&
                        obsCVF_post !== null && obsCVF_post >= linCVF) {
                        postBdCommentsArray.push("Houve normalização da CVF (que estava reduzida) após o broncodilatador.");
                    } 
                    else if (obsCVF_post !== null && linCVF !== null && obsCVF_post >= linCVF && 
                             !(obsCVF_pre_param !== null && obsCVF_pre_param >= linCVF) ) { 
                         postBdCommentsArray.push("A CVF encontra-se dentro dos limites da normalidade após o broncodilatador.");
                    }

                    let vef1Reversible = false;
                    let cvfReversible = false;
                    let vef1ResponseMagnitude = null;
                    let cvfResponseMagnitude = null;
                    let reversibilityStatements = [];

                    if (obsVEF1_pre_param !== null && obsVEF1 !== null && prevVEF1_param !== null && prevVEF1_param !== 0) {
                        const varVEF1PercPrev = calculateDiffPercentOfPredicted(obsVEF1_pre_param, obsVEF1, prevVEF1_param);
                        if (varVEF1PercPrev !== null && varVEF1PercPrev >= 10) {
                            vef1Reversible = true;
                            vef1ResponseMagnitude = varVEF1PercPrev;
                            reversibilityStatements.push(`Resposta significativa do VEF1 (${formatValue(vef1ResponseMagnitude, 1)}% do previsto).`);
                        }
                    }

                    if (obsCVF_pre_param !== null && obsCVF !== null && prevCVF_param !== null && prevCVF_param !== 0) {
                        const varCVFPercPrev = calculateDiffPercentOfPredicted(obsCVF_pre_param, obsCVF, prevCVF_param);
                        if (varCVFPercPrev !== null && varCVFPercPrev >= 10) {
                            cvfReversible = true;
                            cvfResponseMagnitude = varCVFPercPrev;
                            let cvfStatement = `Resposta significativa da CVF (${formatValue(cvfResponseMagnitude, 1)}% do previsto).`;
                            cvfStatement += " Esta resposta na CVF sugere a presença de aprisionamento aéreo na fase pré-broncodilatador.";
                            // CORREÇÃO APLICADA AQUI: Verificar classPreBD para o padrão Misto
                            if (classPreBD === "Misto") { // classPreBD é a classificação do exame Pré-BD
                                cvfStatement += " Sendo o padrão Pré-BD classificado como Misto, esta melhora da CVF Pós-BD sugere redução do aprisionamento de ar.";
                            }
                            reversibilityStatements.push(cvfStatement);
                        }
                    }

                    if (reversibilityStatements.length > 0) {
                        postBdCommentsArray.push("Resposta ao broncodilatador:<br>" + reversibilityStatements.join("<br>"));
                    } else if (obsVEF1_pre_param !== null || obsCVF_pre_param !== null) { 
                        postBdCommentsArray.push("Resposta ao broncodilatador: Não houve resposta significativa segundo o critério de aumento de 10% do previsto para VEF1 ou CVF.");
                    }
                    
                    if (postBdCommentsArray.length > 0) {
                        postBdSpecificText = "<br><br>" + postBdCommentsArray.join("<br><br>"); 
                    }
                }
                
                const classificationHTML = `<strong>Classificação (${label}): ${calculatedClassification}</strong><br><br>`;
                return { text: classificationHTML + baseInterpretationText + postBdSpecificText, classification: calculatedClassification };
            };

            const preBDResult = generateSingleInterpretation(
                obsCVF_pre, linCVF, obsVEF1_pre, linVEF1, computedObsVEF1CVF_pre, linVEF1CVF, zScoreCVF_pre, "Pré-Broncodilatador"
            );
            document.getElementById('interpretation-text-pre').innerHTML = preBDResult.text;
            const preBDClassification = preBDResult.classification;
            document.getElementById('interpretation-section').style.display = 'block';

            const hasPostBDValues = obsCVF_post !== null || obsVEF1_post !== null || obsFEF2575_post !== null;
            const postBDInterpretationElement = document.getElementById('interpretation-text-post');
            const postBDSectionElement = document.getElementById('interpretation-section-post');

            if (hasPostBDValues && computedObsVEF1CVF_post !== null && zScoreCVF_post !== null && obsVEF1_post !== null && obsCVF_post !== null) {
                const postBDResult = generateSingleInterpretation(
                    obsCVF_post, linCVF, obsVEF1_post, linVEF1, computedObsVEF1CVF_post, linVEF1CVF, zScoreCVF_post, "Pós-Broncodilatador",
                    preBDClassification, 
                    obsCVF_pre, obsVEF1_pre, 
                    prevCVF, prevVEF1 
                );
                postBDInterpretationElement.innerHTML = postBDResult.text;
                postBDSectionElement.style.display = 'block';
            } else {
                let postInterpretationMessage = 'Dados Pós-Broncodilatador insuficientes para interpretação completa.';
                if (hasPostBDValues) { 
                     if (computedObsVEF1CVF_post === null && (obsVEF1_post !== null || obsCVF_post !== null)) {
                        postInterpretationMessage = 'Não foi possível calcular VEF1/CVF Pós-BD. Verifique os valores de VEF1 e CVF Pós-BD.';
                    } else if (zScoreCVF_post === null && obsCVF_post !== null) {
                         postInterpretationMessage = 'Não foi possível calcular Z-score da CVF Pós-BD para a regra de Disanapsis.';
                    } else if (obsVEF1_post === null || obsCVF_post === null){
                         postInterpretationMessage = 'Valores de VEF1 e/ou CVF Pós-BD não fornecidos para interpretação completa.';
                    }
                }
                postBDInterpretationElement.innerHTML = postInterpretationMessage;
                 if (hasPostBDValues) { 
                    postBDSectionElement.style.display = 'block';
                 } else {
                    postBDSectionElement.style.display = 'none';
                 }
            }
            document.getElementById('results').style.display = 'block';
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            document.getElementById('spirometryForm').reset(); 
            const today = new Date();
            const foundry = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); 
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('examDate').value = `${foundry}-${mm}-${dd}`;
            document.getElementById('ageMonths').value = '0'; 
            const savedDoctorName = localStorage.getItem('doctorName');
            if (savedDoctorName) document.getElementById('doctorName').value = savedDoctorName;
            const savedClinicName = localStorage.getItem('clinicName');
            if (savedClinicName) document.getElementById('clinicName').value = savedClinicName;

            document.getElementById('results').style.display = 'none'; 
            document.getElementById('ageRangeWarning').style.display = 'none'; 
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none'); 
            document.getElementById('interpretation-section-post').style.display = 'none';
            document.getElementById('interpretation-text-pre').innerHTML = '';
            document.getElementById('interpretation-text-post').innerHTML = '';
        });

        document.getElementById('printButton').addEventListener('click', function() {
            window.print(); 
        });

        document.getElementById('shareButton').addEventListener('click', function() {
            const resultsDiv = document.getElementById('results');
            if (resultsDiv.style.display === 'none') {
                alert('Calcule um exame primeiro para poder compartilhar os resultados.');
                return;
            }
            const formElement = document.getElementById('spirometryForm');
            const actionButtons = document.querySelector('.action-buttons-group');
            const originalFormDisplay = formElement.style.display; 
            const originalButtonsDisplay = actionButtons.style.display; 

            if (formElement) formElement.style.display = 'none';
            if (actionButtons) actionButtons.style.display = 'none'; 

            html2canvas(resultsDiv, {
                scale: 2, 
                useCORS: true,
                logging: false 
            }).then(function(canvas) {
                if (formElement) formElement.style.display = originalFormDisplay; 
                if (actionButtons) actionButtons.style.display = originalButtonsDisplay;

                canvas.toBlob(function(blob) {
                    if (!blob) {
                        alert('Erro ao gerar imagem para compartilhamento.');
                        return;
                    }
                    if (navigator.share) {
                        const file = new File([blob], 'espirometria_resultado.png', { type: 'image/png' });
                        navigator.share({
                            files: [file],
                            title: 'Resultado de Espirometria Pediátrica',
                            text: 'Confira os resultados do exame de espirometria pediátrica:'
                        }).then(() => {
                            // console.log('Compartilhamento bem-sucedido');
                        }).catch((error) => {
                            // console.error('Erro ao compartilhar via Web Share API:', error);
                            if (error.name !== 'AbortError') { 
                                alert('Não foi possível compartilhar diretamente. A imagem será baixada. Você pode compartilhá-la manualmente.');
                                downloadImage(blob, 'espirometria_resultado.png');
                            }
                        });
                    } else {
                        alert('Seu navegador não suporta a função de compartilhamento direto. A imagem será baixada. Você pode compartilhá-la manualmente.');
                        downloadImage(blob, 'espirometria_resultado.png');
                    }
                }, 'image/png');
            }).catch(function(error) {
                if (formElement) formElement.style.display = originalFormDisplay; 
                if (actionButtons) actionButtons.style.display = originalButtonsDisplay;
                // console.error('Erro ao gerar imagem com html2canvas:', error);
                alert('Não foi possível gerar a imagem dos resultados. Tente novamente ou use a função de impressão para salvar em PDF.');
            });
        });

        function downloadImage(blob, filename) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href); 
        }
    </script>
</body>
</html>